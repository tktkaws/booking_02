# リアルタイムバリデーション機能 実装計画

## 背景と目的
- 予約作成・編集時に日付・時間の重複を即時に検知し、ユーザーが安心して操作できるようにする。
- アクセシビリティに配慮したエラーメッセージ表示により、キーボード・スクリーンリーダー利用時の体験を向上させる。

## 対象画面
1. 予約作成ダイアログ (`components/BookingForm.tsx`)
2. 予約詳細ダイアログ内の編集フォーム（将来的に分離する場合は新規編集ダイアログ）

## 仕様整理
### 共通バリデーション
- 日付・開始時間・終了時間がすべて入力されていること。
- 終了時間は開始時間より後であること。
- 予約日は平日（月〜金）のみ許可し、土日祝はエラーとする。
- 指定された日付の予約と重複しないこと。
- 編集時は自身の予約（元の開始/終了）との重複を許容。

### 予約作成
- ダイアログを開いたら、当日の現在時刻に近い開始時間をデフォルトセット。
- 開始時間を選択後、自動的に 1 時間後の終了時間をセット。
- 日付・時間が変更されるたびに同日予約を再取得またはキャッシュを更新し、重複チェックを実行。

### 予約編集
- 編集前の開始/終了時刻は重複チェックから除外する。
- 日付・時間フィールド変更のたびにリアルタイム検証を行う。

### 時間選択肢の制御
- 開始時間を選択したら、終了時間選択肢は開始時間以降のみを表示。
- 終了時間を現在の開始時間 + 1 時間に自動調整（範囲外は最終スロットに丸める）。

### アクセシビリティ
- エラーメッセージは `aria-live="polite"` な領域に表示。
- フォームコントロールとエラー文を `aria-describedby` で関連付け。
- バリデーション失敗時は送信ボタンを `disabled` にし、フォーカス移動時にメッセージが読まれるようにする。

## 実装ステップ
1. **データ取得まわりの整理**
   - 既存の同日予約取得ロジックをフック化（例: `useDayBookings(date)`）。
   - 編集時には対象予約 ID を受け取って除外できるようにする。
2. **バリデーションロジックの共通化**
   - 入力値と既存予約リストを受け取るユーティリティを作成 (`lib/validation/reservation.ts` など)。
   - 平日チェックをユーティリティ内に含め、必要に応じて休日判定ロジック（祝日 API or 設定ファイル）に拡張できる構成にしておく。
   - 戻り値は `{ valid: boolean; errors: ValidationError[] }` の形で統一。
3. **フォーム側への組み込み**
   - `BookingForm` と `BookingDetailDialog` の編集フォームで `useEffect` + `useMemo` を使い、日付・時間変更をトリガーにバリデーション実行。
   - エラーがある場合は表示、`submit` 防止、ボタン `disabled`。
4. **UI 表示の調整**
   - エラーメッセージ領域（`<p role="alert">` または `aria-live`）を追加。
   - 入力欄に `aria-invalid` を設定し、スタイルとして枠線色などを変更。
5. **自動セット処理**
   - 作成ダイアログ表示時に `startTime` を「現在時刻の 15 分刻み切り上げ」、`endTime` を `startTime + 1h` にセット。
   - フォーム内で開始時間変更時に終了時間を自動更新＆選択肢をフィルタリング。
6. **テストケース**
   - DOM テスト（Testing Library）で以下を確認
     - 重複パターンでエラーが表示される。
     - エラー状態で送信ボタンが無効になる。
     - 編集時に元の予約時間は許容される。
     - アクセシビリティ属性が正しく付与される。
   - 非同期部分は Supabase 呼び出しをモックし、異常系（取得失敗）もハンドリング。

## スケジュール目安
| ステップ | 内容 | 目安 |
| --- | --- | --- |
| 1 | フック・ユーティリティ整備 | 0.5日 |
| 2 | バリデーション組み込み（作成フォーム） | 1日 |
| 3 | 編集フォーム対応 | 0.5日 |
| 4 | UI 調整・スタイル・A11y | 0.5日 |
| 5 | テスト整備 | 0.5日 |
| 合計 | - | 約 3 日 |

## リスクと対応
- **予約リスト取得の重さ**: 日付変更ごとのクエリ負荷 → キャッシュまたは最初にまとめて取得し、`filter` で対応。
- **リアルタイム反映の競合**: 別ユーザー更新時との整合性 → 既存の `bookings-updated` イベントを活用し、再検証をトリガー。
- **UI 変更による混乱**: 自動セットや選択肢削除によりユーザーが迷う可能性 → ツールチップや説明文を追加。

## 追加検討事項
- 予約可能時間帯を設定ファイルや DB から取得できるようにし、柔軟に調整できる構成にする。
- 将来的に開始・終了のドラッグ入力（Time picker）を導入する場合の拡張性を確保（`useState` の構造やユーティリティを分離）。
