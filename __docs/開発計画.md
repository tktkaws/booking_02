# 会議室予約システム 開発計画

## 1. 概要
- 単一会議室を対象に、平日 9:00–18:00、15分単位で予約管理。
- ビューはリスト・週間・月間を切替。予約の閲覧は未ログインでも可。
- CRUD はモーダルで実行。部署内編集/削除、管理者は全権限。
- 技術: Next.js + TypeScript, Tailwind CSS, Supabase（Auth/DB/RLS）。

## 2. データモデル（Supabase）
C:\Program Files\Ampps\www\__倉庫\booking_02\__docs\schema.mdを参照
bookingsのuuidは予約者が所属するdepartmentsのuuid

- RLS 方針:
  - `SELECT`: すべてのユーザー（匿名含む）を許可。
  - `INSERT`: 認証済のみ。`department` は `profiles.department` を自動適用。
  - `UPDATE/DELETE`: `is_admin=true` または `bookings.department = viewer.department`。
  - `profiles` のRLS: 管理者のみ `UPDATE/DELETE/SELECT(email,is_admin)`。一般ユーザーは自分のプロフィール更新と公開項目の閲覧のみ。

## 3. 権限/業務ルール
- 競合禁止: 予約は重複不可（半開区間でチェック）。
- 部署権限: 同部署ユーザーは相互に編集/削除可。管理者は全予約/全ユーザー管理可。
- 時間制約: 平日 9:00–18:00 以外は作成/更新不可。15分単位へ丸め/バリデーション。

## 4. 画面/UX
- 共通: ヘッダーにビュー切替（List/Week/Month）、ログイン/ログアウト、現在日時ナビゲーション。
- 管理者リンク: 管理者のみヘッダーに「管理（ユーザー）」リンクを表示。
- リスト: 期間フィルタ、検索（タイトル/作成者/部署）。
- カレンダー: 自作グリッド実装（Google カレンダー風）。
- 月間ビュー: 日セルをクリックで、その「日の現在時刻」を初期値に新規予約モーダルを開く。
- 週間ビュー: 15分ごとのグリッド。クリックした時間を開始時刻として新規予約モーダルを開く。
- モーダル: 詳細表示/作成/編集/削除。権限に応じてボタン表示制御。衝突時は具体的な予約を提示。
- UI 実装: Tailwind。モーダルは Radix UI Dialog を採用。
- 注記: ドラッグによる時間延長・リサイズ機能は実装しない（キャンセル）。

### ページ構成
- トップ（`/`）: 予約表示（リスト/週間/月間）。ログインはモーダル（Radix UI Dialog）で実行。未ログイン時は閲覧のみ、ログイン後に作成/編集/削除が可能。
- ユーザー詳細（`/me`）: 自ユーザー情報の更新フォーム（`display_name`, `department`）。メールは参照のみ、管理者以外は `is_admin` を編集不可。保存後はトースト通知＋フォーカス復帰。
- ユーザー一覧（管理者, `/admin/users`）: 管理者メニュー。
  - 一括更新: 行チェックボックス＋「選択を編集」で一括更新モーダル（変更フィールドのみ適用）。対象フィールド: `department`, `is_admin`（要確認ダイアログ）。
  - 個別編集: 行アクションから編集モーダル。削除はソフトデリート（`deleted_at` 設定）。
  - 検索/並び替え/ページネーションを提供。

### 管理者メニュー（ユーザー一覧）
- ルート: `/admin/users`（保護ルート、`is_admin=true` のみアクセス）。
- 一覧カラム: `display_name`, `email`, `department`, `is_admin`, `created_at`。
- 操作: 編集（Radix Dialog）、削除（確認ダイアログ）。`deleted_at` によるソフトデリートを既定。
- 検索/並び替え/ページネーション: キーワード検索（名前/部署/メール）、`created_at desc` 既定、50件/ページ。
- 注意: Supabase Auth ユーザー削除はサービスロールが必要。必要時は Edge Function 経由で `auth.admin` API を使用（管理者のみ）。

#### 一括更新モーダル（UIワイヤー）
- トリガ: 一覧で行チェック → ツールバーの「選択を編集」。Radix Dialog で開く。
- フィールド: `department`（テキスト or セレクト）、`is_admin`（三状態: 変更なし/付与/剥奪）。
- 入力規則: いずれか1項目は「変更あり」にする。最大選択件数の上限（例: 500）。
- 事前確認: 送信直前に確認ダイアログをネスト表示（対象件数・変更内容の要約）。`is_admin` 付与/剥奪時は注意文言を強調。
- 提交後: 成功件数/失敗件数をトーストと結果ダイアログで表示。失敗行は理由（RLS/競合/検証）をリスト化。
- A11y: Dialog はタイトル/説明を関連付け、送信ボタンは `aria-disabled` 管理、エラーは `aria-live="polite"`。

#### RLS/Edge Function 実装メモ
- RLS（`profiles`）例:
  - 閲覧: `true`（公開項目のみ）。メール/`is_admin` は管理者のみ SELECT 可。
  - 自己更新: `auth.uid() = id` AND 更新列に `is_admin` を含まない。
  - 管理者更新: `exists(select 1 from profiles p where p.id = auth.uid() and p.is_admin)` を満たす場合に UPDATE/DELETE 可。
- 「最後の管理者を剥奪しない」保護:
  - Edge Function 側でトランザクション内チェック: `select count(*) from profiles where is_admin=true` を取得し、更新後も1名以上が維持されることを検証。満たさなければ 409 を返す。
- Edge Function 例（擬似）: `admin-bulk-update`
  - 入力: `{ userIds: uuid[], setDepartment?: string|null, setIsAdmin?: true|false|null }`
  - 検証: JWT で `is_admin` を確認。件数・値検証。
  - 実行: `begin; update profiles set department=coalesce(:dep, department), is_admin=coalesce(:adm, is_admin) where id in (:ids); commit;`
  - ログ: `admin_audit_logs` に操作者・対象件数・差分要約を記録。
  - 失敗時: `rollback`、部分適用はしない（オールオアナッシング）。

## 5. API/サーバロジック
- 取得: `from("bookings").select(...).gte/lte` で期間取得。必要に応じて購読（realtime）。
- 競合検出: `exists` クエリで `[start_at, end_at)` と重なる予約を検査。
- サーバアクション/Edge Functions（任意）: 競合検査＋作成/更新をアトミック化。

## 6. 実装ステップ（マイルストーン）
1) プロジェクト初期化: Next.js(App Router), TypeScript, Tailwind。
2) Supabase セットアップ: プロジェクト作成、スキーマ/ポリシー適用、`profiles` 同期トリガ。
3) 認証: サインイン/アウト、プロフィール取得、管理者フラグ取得。
4) 管理者メニュー: `/admin/users` 一覧・編集・削除（RLS/Edge Function設計含む）。
5) カレンダー UI: 週/月グリッドとリスト、ビュー切替、期間クエリ。
6) CRUD モーダル: 作成/編集/削除、権限制御、バリデーション、競合検出。
7) 仕上げ: 空状態/エラーハンドリング、アクセシビリティ、i18n（日本語）。
8) テスト: 単体/統合/E2E、主要ユースケース網羅。

## 7. バリデーション規則
- 15分刻み: `start_at`/`end_at` は 00/15/30/45 分のみ。
- 営業時間: 平日 9:00–18:00 内、かつ `end_at-start_at >= 15m`。
- 競合: `[start, end)` 区間で重複禁止。

## 8. コマンド例
- 開発起動: `npm run dev`
- Lint/型: `npm run lint` / `npm run type-check`
- Supabase 生成物: `supabase db push` / `supabase migration new <name>`
- UI モーダル導入: `npm i @radix-ui/react-dialog`
 - 依存インストール: `npm i` （Next, React, Tailwind, Supabase クライアント）
 - Tailwind 初期化: `npx tailwindcss init -p`（設定済みのため不要）

## 9. テスト方針
- 単体: 時間丸め、営業時間/平日判定、オーバーラップ関数。
- 統合: CRUD と RLS（部署/管理者）。
- E2E: 週/月/リストでの予約作成→編集→削除の一連。

## 10. 追加メモ
- ライブラリ候補: 日付処理は `date-fns`、カレンダーは自作グリッド or `react-big-calendar`。
- パフォーマンス: 期間フェッチを限定（可視範囲のみ）、仮想化を検討。
- アクセス制御はクライアントとRLSの二重で担保。

## 11. アクセシビリティ（A11y）/キーボード操作
- 役割/属性: カレンダーは `role="grid"`、行は `role="row"`、セルは `role="gridcell"`。今日のセルは `aria-current="date"`。選択中セルは `aria-selected=true`。営業時間外セルはフォーカス不可（`aria-disabled=true`）。
- フォーカス管理: ロービング tabindex（フォーカス可能セルのみ `tabindex=0`、他は `-1`）。モーダルを閉じたら起点セルへフォーカスを返す。
- 月間ビューのキー操作:
  - 矢印: 上下左右で日付±1日/行。
  - PageUp/PageDown: 前月/翌月。Shift+同: 前年/翌年。
  - Home/End: 週の開始/終了へ移動。
  - Enter/N: その日の「現在時刻」を初期値に新規予約モーダルを開く。
- 週間ビューのキー操作（15分刻みグリッド）:
  - 上下: 時刻±15分（営業時間外へは移動しない）。
  - 左右: 前日/翌日（同時刻）。
  - Home/End: 当日9:00/18:00へ。
  - PageUp/PageDown: 前週/翌週。
  - Ctrl+上下（任意）: 時刻±60分。
  - Enter/N: フォーカス位置の開始時刻で新規予約モーダルを開く。
- 予約要素: 予約カードは `role="button"` でタブ移動可能。Enter で詳細モーダル。削除はモーダル内で確認ダイアログ。
- モーダル: `role="dialog" aria-modal="true"`。タイトルに `aria-labelledby`、説明に `aria-describedby`。Esc で閉じる。初期フォーカスはタイトルか最初の入力へ。フォーカストラップを実装。
- 時刻入力: `type=time`（`step=900`）またはコンボボックス。上下キーで±15分。無効値は `aria-invalid` とエラーメッセージを `aria-describedby` で関連付け。
- ライブリージョン: ビュー切替/期間変更/作成・更新・削除は `aria-live="polite"` で通知（例: 「2025年9月第1週に移動」「予約を作成しました」）。
- 追加配慮: 視認しやすいフォーカスリング、コントラスト遵守、マウス依存操作は避ける（ドラッグ/リサイズは未実装）。
